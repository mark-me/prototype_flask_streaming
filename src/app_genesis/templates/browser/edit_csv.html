{% extends "base.html" %}

{% block title %}CSV Editor{% endblock %}

{% block content %}
<div class="d-flex justify-content-between mt-3">

  <h2>CSV bewerken</h2>
  <a href="#" onclick="close_window(warning=false);return false;" class="btn btn-close" aria-label="Close"></a>
</div>
<div id="csv-table"></div>
<button class="btn btn-success mt-3" onclick="downloadCSV()">Opslaan als CSV</button>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='pkgs/paparse/js/papaparse.min.js') }}"></script>
<script src="{{ url_for('static', filename='pkgs/tabulator/js/tabulator.min.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='pkgs/tabulator/css/tabulator.min.css') }}" />
<link rel="stylesheet" href="{{ url_for('static', filename='pkgs/tabulator/css/tabulator_bootstrap5.min.css') }}" />
<script>
  // Initialiseer Tabulator
  var table = new Tabulator("#csv-table", {
    layout: "fitDataStretch",
    movableColumns: true,
    height: "500px",
    columns: [],
    data: [],
  });

  // Haal CSV op via endpoint
  fetch("{{ url_for('browser.get_csv_data', path_file=path_file) }}")
    .then(response => response.text())
    .then(csvText => {
      var parsed = Papa.parse(csvText, { header: true });

      // Zet de kolommen in Tabulator
      table.setColumns(parsed.meta.fields.map(field => ({
        title: field,
        field: field,
        editor: "input"
      })));

      // Zet de data in Tabulator
      table.setData(parsed.data);
    });

  // Opslaan als CSV
  function downloadCSV() {
    var data = table.getData();
    var csv = Papa.unparse(data);

    fetch("{{ url_for('browser.save_csv_data', path_file=path_file) }}", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ csv: csv })
    }).then(response => {
      if (response.ok) alert("CSV opgeslagen!");
      else alert("Fout bij opslaan.");
    });
  }
</script>
<script src="{{ url_for('static', filename='js/close_window.js') }}"></script>
{% endblock %}
